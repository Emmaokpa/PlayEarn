/**
 * @fileoverview Firestore Security Rules for the RewardPlay application.
 *
 * Core Philosophy:
 * This ruleset enforces a strict user-ownership model for user-specific data and allows public read access for game and reward metadata.
 *
 * Data Structure:
 * - /users/{userId}: User profiles, accessible only to the user themselves.
 * - /games/{gameId}: Game metadata, publicly readable, writeable by admins only.  Admin status is not yet enforced, so writes are currently disabled.
 * - /rewards/{rewardId}: Reward definitions, publicly readable, writeable by admins only. Admin status is not yet enforced, so writes are currently disabled.
 * - /users/{userId}/rewards/{rewardId}: User-specific rewards, accessible only to the user themselves.
 * - /users/{userId}/adViews/{adViewId}: User-specific ad views, accessible only to the user themselves.
 * - /users/{userId}/gameProgress/{gameProgressId}: User-specific game progress, accessible only to the user themselves.
 *
 * Key Security Decisions:
 * - User listing is disallowed to protect user privacy.
 * - Admin roles are not yet implemented; writes to /games and /rewards are currently disabled.
 * - All writes to user-owned data require a verified user ID that matches the path.
 * - No schema validation is enforced beyond authorization checks to allow for rapid prototyping.
 *
 * Denormalization for Authorization:
 * - User ownership is enforced via path-based rules (e.g., /users/{userId}), avoiding the need for `get()` calls to verify ownership.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Checks if the request is authenticated.
     * @return {boolean} True if the request is authenticated, false otherwise.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * @description Checks if the authenticated user ID matches the provided user ID.
     * @param {string} userId The user ID to compare against.
     * @return {boolean} True if the user ID matches, false otherwise.
     */
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    /**
     * @description Checks if the authenticated user is the owner of the existing document.
     * @param {string} userId The user ID to compare against.
     * @return {boolean} True if the user is the owner and the document exists, false otherwise.
     */
    function isExistingOwner(userId) {
        return isOwner(userId) && resource != null;
    }

    /**
     * @description Rules for user profiles.
     * @path /users/{userId}
     * @allow (create) User with ID 'user123' can create their profile.
     *    request.auth.uid = 'user123'
     *    request.resource.data.id = 'user123'
     * @deny (create) User with ID 'user456' cannot create profile for 'user123'.
     *    request.auth.uid = 'user456'
     *    request.resource.data.id = 'user123'
     * @principle Enforces document ownership for writes and validates relational integrity.
     */
    match /users/{userId} {
      allow get: if isOwner(userId);
      allow list: if false; // User listing is not permitted.
      allow create: if isOwner(userId) && request.resource.data.id == userId;
      allow update: if isExistingOwner(userId) && request.resource.data.id == resource.data.id;
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Rules for games.
     * @path /games/{gameId}
     * @allow (get) Any user can read game metadata.
     * @deny (create) No user can create, update, or delete games at the moment because admin role is not yet defined.
     * @principle Publicly readable, but only admins can create/update (currently disabled).
     */
    match /games/{gameId} {
      allow get, list: if true;
      allow create, update, delete: if false; // TODO: Add admin role check once defined.
    }

    /**
     * @description Rules for rewards.
     * @path /rewards/{rewardId}
     * @allow (get) Any user can read reward definitions.
     * @deny (create) No user can create, update, or delete rewards at the moment because admin role is not yet defined.
     * @principle Publicly readable, but only admins can create/update (currently disabled).
     */
    match /rewards/{rewardId} {
      allow get, list: if true;
      allow create, update, delete: if false; // TODO: Add admin role check once defined.
    }

    /**
     * @description Rules for user-specific rewards.
     * @path /users/{userId}/rewards/{rewardId}
     * @allow (create) User with ID 'user123' can create a reward record for themselves.
     *    request.auth.uid = 'user123'
     * @deny (create) User with ID 'user456' cannot create a reward record for 'user123'.
     *    request.auth.uid = 'user456'
     * @principle Enforces document ownership for writes.
     */
    match /users/{userId}/rewards/{rewardId} {
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isOwner(userId);
      allow update: if isExistingOwner(userId);
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Rules for user-specific ad views.
     * @path /users/{userId}/adViews/{adViewId}
     * @allow (create) User with ID 'user123' can create an ad view record for themselves.
     *    request.auth.uid = 'user123'
     * @deny (create) User with ID 'user456' cannot create an ad view record for 'user123'.
     *    request.auth.uid = 'user456'
     * @principle Enforces document ownership for writes.
     */
    match /users/{userId}/adViews/{adViewId} {
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isOwner(userId);
      allow update: if isExistingOwner(userId);
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Rules for user-specific game progress.
     * @path /users/{userId}/gameProgress/{gameProgressId}
     * @allow (create) User with ID 'user123' can create a game progress record for themselves.
     *    request.auth.uid = 'user123'
     * @deny (create) User with ID 'user456' cannot create a game progress record for 'user123'.
     *    request.auth.uid = 'user456'
     * @principle Enforces document ownership for writes.
     */
    match /users/{userId}/gameProgress/{gameProgressId} {
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isOwner(userId);
      allow update: if isExistingOwner(userId);
      allow delete: if isExistingOwner(userId);
    }
  }
}