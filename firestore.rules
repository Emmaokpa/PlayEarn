/**
 * @fileoverview Firestore Security Rules for the RewardPlay application.
 *
 * Core Philosophy:
 * This ruleset enforces a strict user-ownership model for user-specific data and allows public read access for game and reward metadata.
 * It is designed for a Telegram Mini App, where authentication is handled via custom tokens and the user's Telegram ID serves as their Firebase UID.
 *
 * Data Structure:
 * - /users/{userId}: User profiles, accessible only to the user themselves. The {userId} is the user's Telegram ID.
 * - /games/{gameId}: Game metadata, publicly readable, writeable by admins only. Admin status is not yet enforced, so writes are currently disabled.
 * - /rewards/{rewardId}: Reward definitions, publicly readable, writeable by admins only. Admin status is not yet enforced, so writes are currently disabled.
 * - /stickerPacks/{stickerPackId}: Sticker packs, publicly readable, writeable by admins only.
 * - /users/{userId}/rewards/{rewardId}: User-specific rewards, accessible only to the user themselves.
 * - /users/{userId}/adViews/{adViewId}: User-specific ad views, accessible only to the user themselves.
 * - /users/{userId}/gameProgress/{gameProgressId}: User-specific game progress, accessible only to the user themselves.
 *
 * Key Security Decisions:
 * - User listing is disallowed to protect user privacy.
 * - Admin roles are not yet implemented; writes to /games, /rewards and /stickerPacks are currently disabled.
 * - All writes to user-owned data require a verified user ID that matches the path.
 * - Schema validation ensures data integrity upon creation.
 *
 * Denormalization for Authorization:
 * - User ownership is enforced via path-based rules (e.g., /users/{userId}), avoiding the need for `get()` calls to verify ownership.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Checks if the request is authenticated.
     * @return {boolean} True if the request is authenticated, false otherwise.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * @description Checks if the authenticated user ID matches the provided user ID.
     * @param {string} userId The user ID to compare against.
     * @return {boolean} True if the user ID matches, false otherwise.
     */
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }
    
    /**
     * @description Validates the fields of a UserProfile document on creation.
     * @param {map} data The incoming resource data.
     * @return {boolean} True if the data is valid, false otherwise.
     */
    function isValidUserProfile(data) {
        return data.telegramId is string &&
               data.username is string &&
               data.name is string &&
               data.avatarUrl is string &&
               data.coins is number &&
               data.referralCode is string &&
               data.isVip == false && // New users cannot be VIPs
               data.registrationDate == request.time;
    }


    /**
     * @description Rules for user profiles.
     * @path /users/{userId}
     * @principle Enforces document ownership for writes and validates relational integrity.
     */
    match /users/{userId} {
      allow get, list: if isOwner(userId);
      allow create: if isOwner(userId) 
                      && request.resource.data.id == userId
                      && isValidUserProfile(request.resource.data);
      allow update: if isOwner(userId)
                      // Prevent changing critical IDs
                      && request.resource.data.id == resource.data.id
                      && request.resource.data.telegramId == resource.data.telegramId;
      allow delete: if isOwner(userId);

      // Rules for all subcollections under a user's document
      match /{allPaths=**} {
        allow read, write: if isOwner(userId);
      }
    }

    /**
     * @description Rules for games.
     * @path /games/{gameId}
     * @principle Publicly readable, but only admins can create/update (currently disabled).
     */
    match /games/{gameId} {
      allow get, list: if true;
      allow create, update, delete: if false; // TODO: Add admin role check once defined.
    }

    /**
     * @description Rules for rewards.
     * @path /rewards/{rewardId}
     * @principle Publicly readable, but only admins can create/update (currently disabled).
     */
    match /rewards/{rewardId} {
      allow get, list: if true;
      allow create, update, delete: if false; // TODO: Add admin role check once defined.
    }

    /**
     * @description Rules for sticker packs.
     * @path /stickerPacks/{stickerPackId}
     * @principle Publicly readable, but only admins can create/update (currently disabled).
     */
    match /stickerPacks/{stickerPackId} {
        allow get, list: if true;
        allow create, update, delete: if false; // TODO: Add admin role check once defined.
    }
  }
}

    