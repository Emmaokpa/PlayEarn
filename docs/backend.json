
{
  "entities": {
    "UserProfile": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "UserProfile",
      "type": "object",
      "description": "Represents a user profile in the RewardPlay application.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the user profile, matching the Firebase Auth user ID."
        },
        "telegramId": {
          "type": "string",
          "description": "The Telegram user ID associated with this profile (can be same as user ID for now)."
        },
        "username": {
          "type": "string",
          "description": "The user's chosen username."
        },
        "name": {
            "type": "string",
            "description": "The display name of the user."
        },
        "avatarUrl": {
            "type": "string",
            "description": "URL of the user's avatar image."
        },
        "coins": {
            "type": "number",
            "description": "The number of coins the user has."
        },
        "referralCode": {
            "type": "string",
            "description": "The user's unique referral code."
        },
        "isVip": {
            "type": "boolean",
            "description": "Indicates if the user is a VIP member."
        },
        "isAdmin": {
          "type": "boolean",
          "description": "Indicates if the user has administrative privileges."
        },
        "registrationDate": {
          "type": "string",
          "description": "The date and time the user registered.",
          "format": "date-time"
        },
        "gamePlaysToday": {
            "type": "number",
            "description": "The number of game sessions played today. Resets daily."
        },
        "lastGameplayReset": {
            "type": "string",
            "description": "The date of the last gameplay reset (YYYY-MM-DD)."
        }
      },
      "required": [
        "id",
        "telegramId",
        "username",
        "name",
        "avatarUrl",
        "coins",
        "referralCode",
        "isVip",
        "isAdmin",
        "registrationDate"
      ]
    },
    "Game": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Game",
      "type": "object",
      "description": "Represents a game available in the RewardPlay application.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the game."
        },
        "name": {
          "type": "string",
          "description": "The name of the game."
        },
        "category": {
          "type": "string",
          "description": "The category of the game."
        },
        "iframeUrl": {
          "type": "string",
          "description": "The URL to embed the game."
        },
        "imageUrl": {
          "type": "string",
          "description": "The URL for the game's cover image."
        },
        "imageHint": {
          "type": "string",
          "description": "Keywords for AI image search."
        }
      },
      "required": [
        "id",
        "name",
        "category",
        "iframeUrl",
        "imageUrl",
        "imageHint"
      ]
    },
    "Reward": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Reward",
      "type": "object",
      "description": "Represents a reward that a user can earn or redeem.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the reward."
        },
        "name": {
          "type": "string",
          "description": "The name of the reward."
        },
        "description": {
          "type": "string",
          "description": "A description of the reward."
        },
        "coins": {
          "type": "number",
          "description": "The number of coins required to redeem this reward."
        }
      },
      "required": [
        "id",
        "name",
        "description",
        "coins"
      ]
    },
    "UserReward": {
      "$schema": "http://json-schema.org/draft-07-schema#",
      "title": "UserReward",
      "type": "object",
      "description": "Represents a reward earned or redeemed by a user.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the user reward."
        },
        "userId": {
          "type": "string",
          "description": "Reference to UserProfile. (Relationship: UserProfile 1:N UserReward)"
        },
        "rewardId": {
          "type": "string",
          "description": "Reference to Reward. (Relationship: Reward 1:N UserReward)"
        },
        "dateEarned": {
          "type": "string",
          "description": "The date and time the reward was earned.",
          "format": "date-time"
        },
        "dateRedeemed": {
          "type": "string",
          "description": "The date and time the reward was redeemed. Null if not redeemed.",
          "format": "date-time"
        }
      },
      "required": [
        "id",
        "userId",
        "rewardId",
        "dateEarned"
      ]
    },
    "AdView": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "AdView",
      "type": "object",
      "description": "Represents a video ad view by a user.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the ad view."
        },
        "userId": {
          "type": "string",
          "description": "Reference to UserProfile. (Relationship: UserProfile 1:N AdView)"
        },
        "adId": {
          "type": "string",
          "description": "Identifier for the ad. Could be an external ad network ID."
        },
        "timestamp": {
          "type": "object",
          "description": "The server-side timestamp when the ad was viewed."
        }
      },
      "required": [
        "id",
        "userId",
        "adId",
        "timestamp"
      ]
    },
    "GameProgress": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "GameProgress",
      "type": "object",
      "description": "Represents a user's progress in a specific game.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the game progress record."
        },
        "userId": {
          "type": "string",
          "description": "Reference to UserProfile. (Relationship: UserProfile 1:N GameProgress)"
        },
        "gameId": {
          "type": "string",
          "description": "Reference to Game. (Relationship: Game 1:N GameProgress)"
        },
        "progressData": {
          "type": "string",
          "description": "JSON string representing the user's progress in the game. Format is game-specific."
        },
        "lastUpdated": {
          "type": "string",
          "description": "The date and time the progress was last updated.",
          "format": "date-time"
        }
      },
      "required": [
        "id",
        "userId",
        "gameId",
        "progressData",
        "lastUpdated"
      ]
    },
    "StickerPack": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "StickerPack",
      "type": "object",
      "description": "Represents a pack of digital stickers that can be purchased in the store.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the sticker pack."
        },
        "name": {
          "type": "string",
          "description": "The name of the sticker pack."
        },
        "description": {
          "type": "string",
          "description": "A description of the sticker pack."
        },
        "price": {
          "type": "number",
          "description": "The price of the sticker pack in coins."
        }
      },
      "required": [
        "id",
        "name",
        "price"
      ]
    },
    "InAppPurchase": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "InAppPurchase",
      "type": "object",
      "description": "Represents a pack of virtual goods (coins, spins, etc.) that can be purchased with real money.",
      "properties": {
        "id": { "type": "string", "description": "Unique identifier for the purchase pack." },
        "type": { "type": "string", "enum": ["coins", "spins"], "description": "The type of item being purchased." },
        "name": { "type": "string", "description": "The name of the pack (e.g., 'Starter Pack')." },
        "description": { "type": "string", "description": "A short description of the pack." },
        "amount": { "type": "number", "description": "The quantity of items in the pack (e.g., number of coins or spins)." },
        "price": { "type": "number", "description": "The price of the pack in USD." }
      },
      "required": ["id", "type", "name", "amount", "price"]
    },
    "AffiliateOffer": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "AffiliateOffer",
      "type": "object",
      "description": "Represents an affiliate offer that users can complete for rewards.",
      "properties": {
        "id": { "type": "string", "description": "Unique identifier for the offer." },
        "title": { "type": "string", "description": "The title of the offer." },
        "description": { "type": "string", "description": "A description of the offer." },
        "link": { "type": "string", "description": "The affiliate URL." },
        "imageUrl": { "type": "string", "description": "URL for the offer's image." },
        "imageHint": { "type": "string", "description": "Keywords for AI image search." },
        "rewardCoins": { "type": "number", "description": "Coins awarded for completing the offer." }
      },
      "required": ["id", "title", "description", "link", "imageUrl", "imageHint", "rewardCoins"]
    },
    "UserAffiliate": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "UserAffiliate",
      "type": "object",
      "description": "Tracks a user's completion of an affiliate offer.",
      "properties": {
        "id": { "type": "string", "description": "Unique ID for this completion record." },
        "userId": { "type": "string", "description": "ID of the user who completed the offer." },
        "offerId": { "type": "string", "description": "ID of the completed affiliate offer." },
        "completedAt": { "type": "string", "description": "Timestamp of completion.", "format": "date-time" }
      },
      "required": ["id", "userId", "offerId", "completedAt"]
    },
     "AffiliateSubmission": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "AffiliateSubmission",
      "type": "object",
      "description": "Represents a user's submission for completing an affiliate offer, pending admin review.",
      "properties": {
        "id": { "type": "string", "description": "Unique identifier for the submission." },
        "userId": { "type": "string", "description": "The ID of the user submitting." },
        "userName": { "type": "string", "description": "The name of the user for easy identification in admin panel." },
        "offerId": { "type": "string", "description": "The ID of the affiliate offer." },
        "offerTitle": { "type": "string", "description": "The title of the offer for easy identification." },
        "proofText": { "type": "string", "description": "The text proof submitted by the user (e.g., username, email)." },
        "proofImageUrl": { "type": "string", "description": "The URL of the image proof submitted by the user (e.g., screenshot)." },
        "status": { "type": "string", "enum": ["pending", "approved", "rejected"], "description": "The status of the submission." },
        "submittedAt": { "type": "string", "format": "date-time", "description": "Timestamp of when the submission was made." },
        "rewardAmount": { "type": "number", "description": "The number of coins to be rewarded upon approval." }
      },
      "required": ["id", "userId", "userName", "offerId", "offerTitle", "status", "submittedAt", "rewardAmount"]
    },
    "UserSpinData": {
        "$schema": "http://json-schema.org/draft-07/schema#",
        "title": "UserSpinData",
        "type": "object",
        "description": "Tracks a user's spin-to-win feature status.",
        "properties": {
            "id": { "type": "string", "description": "Unique ID, same as user ID." },
            "freeSpinsRemaining": { "type": "number", "description": "Resets to 1 daily." },
            "adSpinsUsedToday": { "type": "number", "description": "Resets daily, max 3." },
            "purchasedSpinsRemaining": { "type": "number", "description": "Number of spins bought." },
            "lastSpinTimestamp": { "type": "string", "format": "date-time", "description": "Timestamp of the last spin." },
            "lastResetDate": { "type": "string", "format": "date", "description": "The date of the last daily reset (YYYY-MM-DD)." }
        },
        "required": ["id", "freeSpinsRemaining", "adSpinsUsedToday", "purchasedSpinsRemaining", "lastResetDate"]
    },
    "SpinHistory": {
        "$schema": "http://json-schema.org/draft-07/schema#",
        "title": "SpinHistory",
        "type": "object",
        "description": "A record of a single spin event for a user.",
        "properties": {
            "id": { "type": "string", "description": "Unique ID for the spin record." },
            "userId": { "type": "string", "description": "ID of the user who spun." },
            "prizeWon": { "type": "object", "description": "An object detailing the prize won." },
            "spinType": { "type": "string", "enum": ["free", "ad", "purchased"], "description": "The type of spin used." },
            "timestamp": { "type": "string", "format": "date-time", "description": "When the spin occurred." }
        },
        "required": ["id", "userId", "prizeWon", "spinType", "timestamp"]
    },
    "UserPrize": {
        "$schema": "http://json-schema.org/draft-07/schema#",
        "title": "UserPrize",
        "type": "object",
        "description": "Represents a non-coin prize won by a user, e.g. from the spin wheel.",
        "properties": {
            "id": { "type": "string", "description": "Unique ID for the prize instance." },
            "userId": { "type": "string", "description": "ID of the user who won the prize." },
            "prize": { "type": "object", "description": "The full prize object that was won." },
            "status": { "type": "string", "enum": ["unclaimed", "claimed"], "description": "The current status of the prize." },
            "wonAt": { "type": "string", "format": "date-time", "description": "Timestamp of when the prize was won." }
        },
        "required": ["id", "userId", "prize", "status", "wonAt"]
    },
    "DailyChallenges": {
        "$schema": "http://json-schema.org/draft-07/schema#",
        "title": "DailyChallenges",
        "type": "object",
        "description": "Tracks a user's daily challenge completion status.",
        "properties": {
            "id": { "type": "string", "description": "Unique ID for the record, should be the date (YYYY-MM-DD)." },
            "claimed": { "type": "array", "items": { "type": "string" }, "description": "An array of challenge IDs that have been claimed for this day." }
        },
        "required": ["id", "claimed"]
    }
  },
  "auth": {
    "providers": [
      "password"
    ]
  },
  "firestore": {
    "structure": [
      {
        "path": "/users/{userId}",
        "definition": {
          "entityName": "UserProfile",
          "schema": {
            "$ref": "#/backend/entities/UserProfile"
          },
          "description": "Stores user profile information, keyed by Firebase Auth user ID. Path-based ownership: only the user with matching userId can read/write. This implicitly grants the user to read and write all subcollections of this document.",
          "params": [
            {
              "name": "userId",
              "description": "The unique ID of the user, from Firebase Auth."
            }
          ]
        }
      },
      {
        "path": "/games/{gameId}",
        "definition": {
          "entityName": "Game",
          "schema": {
            "$ref": "#/backend/entities/Game"
          },
          "description": "Stores game definitions. Publicly readable, but only admins can create/update.",
          "params": [
            {
              "name": "gameId",
              "description": "The unique ID of the game."
            }
          ]
        }
      },
      {
        "path": "/rewards/{rewardId}",
        "definition": {
          "entityName": "Reward",
          "schema": {
            "$ref": "#/backend/entities/Reward"
          },
          "description": "Stores reward definitions. Publicly readable, but only admins can create/update.",
          "params": [
            {
              "name": "rewardId",
              "description": "The unique ID of the reward."
            }
          ]
        }
      },
      {
        "path": "/stickerPacks/{stickerPackId}",
        "definition": {
          "entityName": "StickerPack",
          "schema": {
            "$ref": "#/backend/entities/StickerPack"
          },
          "description": "Stores sticker pack information. Publicly readable, but only admins can create/update.",
          "params": [
            {
              "name": "stickerPackId",
              "description": "The unique ID of the sticker pack."
            }
          ]
        }
      },
       {
        "path": "/inAppPurchases/{purchaseId}",
        "definition": {
          "entityName": "InAppPurchase",
          "schema": { "$ref": "#/backend/entities/InAppPurchase" },
          "description": "Stores definitions for all in-app purchases (e.g., coin packs, spin packs). Publicly readable, but only admins can create/update.",
          "params": [{ "name": "purchaseId", "description": "The unique ID of the purchase pack." }]
        }
      },
      {
        "path": "/affiliateOffers/{offerId}",
        "definition": {
          "entityName": "AffiliateOffer",
          "schema": { "$ref": "#/backend/entities/AffiliateOffer" },
          "description": "Stores affiliate offer details. Publicly readable, but only admins can create/update.",
          "params": [{ "name": "offerId", "description": "The unique ID of the affiliate offer." }]
        }
      },
       {
        "path": "/affiliateSubmissions/{submissionId}",
        "definition": {
          "entityName": "AffiliateSubmission",
          "schema": { "$ref": "#/backend/entities/AffiliateSubmission" },
          "description": "Global collection for all affiliate submissions pending admin review. Readable/writable only by admins.",
          "params": [{ "name": "submissionId", "description": "The unique ID for the submission." }]
        }
      },
      {
        "path": "/users/{userId}/rewards/{rewardId}",
        "definition": {
          "entityName": "UserReward",
          "schema": {
            "$ref": "#/backend/entities/UserReward"
          },
          "description": "Stores rewards earned or redeemed by a user. Path-based ownership: only the user with matching userId can read/write.",
          "params": [
            {
              "name": "userId",
              "description": "The unique ID of the user."
            },
            {
              "name": "rewardId",
              "description": "The unique ID of the reward."
            }
          ]
        }
      },
      {
        "path": "/users/{userId}/adViews/{adViewId}",
        "definition": {
          "entityName": "AdView",
          "schema": {
            "$ref": "#/backend/entities/AdView"
          },
          "description": "Stores ad views by a user. Path-based ownership: only the user with matching userId can read/write.",
          "params": [
            {
              "name": "userId",
              "description": "The unique ID of the user."
            },
            {
              "name": "adViewId",
              "description": "The unique ID of the ad view."
            }
          ]
        }
      },
      {
        "path": "/users/{userId}/gameProgress/{gameProgressId}",
        "definition": {
          "entityName": "GameProgress",
          "schema": {
            "$ref": "#/backend/entities/GameProgress"
          },
          "description": "Stores game progress for a user. Path-based ownership: only the user with matching userId can read/write.",
          "params": [
            {
              "name": "userId",
              "description": "The unique ID of the user."
            },
            {
              "name": "gameProgressId",
              "description": "The unique ID of the game progress record."
            }
          ]
        }
      },
       {
        "path": "/users/{userId}/affiliateSignups/{offerId}",
        "definition": {
          "entityName": "UserAffiliate",
          "schema": { "$ref": "#/backend/entities/UserAffiliate" },
          "description": "Tracks which affiliate offers a user has completed. Path-based ownership.",
          "params": [
            { "name": "userId", "description": "The unique ID of the user." },
            { "name": "offerId", "description": "The unique ID of the offer." }
          ]
        }
      },
      {
        "path": "/users/{userId}/spinData/spin_status",
        "definition": {
          "entityName": "UserSpinData",
          "schema": { "$ref": "#/backend/entities/UserSpinData" },
          "description": "A singleton document storing the spin status for a user. Path-based ownership.",
          "params": [
            { "name": "userId", "description": "The unique ID of the user." }
          ]
        }
      },
      {
        "path": "/users/{userId}/spinHistory/{spinId}",
        "definition": {
          "entityName": "SpinHistory",
          "schema": { "$ref": "#/backend/entities/SpinHistory" },
          "description": "A collection of all spins a user has made. Path-based ownership.",
          "params": [
            { "name": "userId", "description": "The unique ID of the user." },
            { "name": "spinId", "description": "The unique ID for the spin event." }
          ]
        }
      },
      {
        "path": "/users/{userId}/prizes/{prizeId}",
        "definition": {
          "entityName": "UserPrize",
          "schema": { "$ref": "#/backend/entities/UserPrize" },
          "description": "A collection of all non-coin prizes a user has won. Path-based ownership.",
          "params": [
            { "name": "userId", "description": "The unique ID of the user." },
            { "name": "prizeId", "description": "The unique ID for the prize record." }
          ]
        }
      },
      {
        "path": "/users/{userId}/dailyChallenges/{date}",
        "definition": {
          "entityName": "DailyChallenges",
          "schema": { "$ref": "#/backend/entities/DailyChallenges" },
          "description": "A collection storing daily challenge completion status for a user, keyed by date (YYYY-MM-DD). Path-based ownership.",
          "params": [
            { "name": "userId", "description": "The unique ID of the user." },
            { "name": "date", "description": "The date of the challenge status (YYYY-MM-DD)." }
          ]
        }
      }
    ],
    "reasoning": "The Firestore structure is designed to support the RewardPlay application, focusing on scalability, security, and ease of maintenance. It leverages path-based ownership for user-specific data and denormalization where necessary to maintain authorization independence. The structure avoids complex rules by segregating data based on access patterns.\n\n*   **User Profiles:** `/users/{userId}` stores user profile data. This is a path-based ownership model, making rules straightforward.\n*   **Games:** `/games/{gameId}` stores game definitions. These are publicly readable.\n*   **Rewards:** `/rewards/{rewardId}` stores reward definitions. These are also globally accessible.\n*   **Sticker Packs:** `/stickerPacks/{stickerPackId}` stores sticker pack definitions. These are also globally accessible.\n*   **In-App Purchases:** `/inAppPurchases/{purchaseId}` is a new generic collection for all real-money purchases, replacing the old `coinPacks` collection to support both coins and spins. Publicly readable.\n*   **Affiliate Offers:** `/affiliateOffers/{offerId}` stores affiliate offer details, publicly readable but writeable only by admins.\n*   **User-Specific Subcollections:** All subcollections under `/users/{userId}` (rewards, adViews, gameProgress, affiliateSignups, spinData, spinHistory, prizes, dailyChallenges) implicitly inherit authorization based on the `userId` in the path. This eliminates the need for `get()` calls in security rules to validate user ownership, enabling atomic operations.\n\n**Authorization Independence:**  All subcollections under `/users/{userId}` implicitly inherit authorization based on the `userId` in the path. This eliminates the need for `get()` calls in security rules to validate user ownership, enabling atomic operations.\n\n**QAPs Support:** Segregation into user-owned subcollections enables efficient and secure `list` operations. Rules can simply check `request.auth.uid == userId` for any operations on `/users/{userId}/**`.\n\nThis structure avoids the use of custom claims (DBAC), relying solely on `request.auth.uid` for authorization, and enforces consistent naming conventions to improve debuggability."
  }
}
