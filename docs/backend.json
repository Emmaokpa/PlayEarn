
{
  "entities": {
    "UserProfile": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "UserProfile",
      "type": "object",
      "description": "Represents a user profile in the RewardPlay application.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the user profile, matching the Firebase Auth user ID."
        },
        "telegramId": {
          "type": "string",
          "description": "The Telegram user ID associated with this profile (can be same as user ID for now)."
        },
        "username": {
          "type": "string",
          "description": "The user's chosen username."
        },
        "name": {
            "type": "string",
            "description": "The display name of the user."
        },
        "avatarUrl": {
            "type": "string",
            "description": "URL of the user's avatar image."
        },
        "coins": {
            "type": "number",
            "description": "The number of coins the user has."
        },
        "referralCode": {
            "type": "string",
            "description": "The user's unique referral code."
        },
        "isVip": {
            "type": "boolean",
            "description": "Indicates if the user is a VIP member."
        },
        "isAdmin": {
          "type": "boolean",
          "description": "Indicates if the user has administrative privileges."
        },
        "registrationDate": {
          "type": "string",
          "description": "The date and time the user registered.",
          "format": "date-time"
        }
      },
      "required": [
        "id",
        "telegramId",
        "username",
        "name",
        "avatarUrl",
        "coins",
        "referralCode",
        "isVip",
        "isAdmin",
        "registrationDate"
      ]
    },
    "Game": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Game",
      "type": "object",
      "description": "Represents a game available in the RewardPlay application.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the game."
        },
        "name": {
          "type": "string",
          "description": "The name of the game."
        },
        "category": {
          "type": "string",
          "description": "The category of the game."
        },
        "iframeUrl": {
          "type": "string",
          "description": "The URL to embed the game."
        },
        "imageUrl": {
          "type": "string",
          "description": "The URL for the game's cover image."
        },
        "imageHint": {
          "type": "string",
          "description": "Keywords for AI image search."
        }
      },
      "required": [
        "id",
        "name",
        "category",
        "iframeUrl",
        "imageUrl",
        "imageHint"
      ]
    },
    "Reward": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Reward",
      "type": "object",
      "description": "Represents a reward that a user can earn or redeem.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the reward."
        },
        "name": {
          "type": "string",
          "description": "The name of the reward."
        },
        "description": {
          "type": "string",
          "description": "A description of the reward."
        },
        "coins": {
          "type": "number",
          "description": "The number of coins required to redeem this reward."
        }
      },
      "required": [
        "id",
        "name",
        "description",
        "coins"
      ]
    },
    "UserReward": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "UserReward",
      "type": "object",
      "description": "Represents a reward earned or redeemed by a user.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the user reward."
        },
        "userId": {
          "type": "string",
          "description": "Reference to UserProfile. (Relationship: UserProfile 1:N UserReward)"
        },
        "rewardId": {
          "type": "string",
          "description": "Reference to Reward. (Relationship: Reward 1:N UserReward)"
        },
        "dateEarned": {
          "type": "string",
          "description": "The date and time the reward was earned.",
          "format": "date-time"
        },
        "dateRedeemed": {
          "type": "string",
          "description": "The date and time the reward was redeemed. Null if not redeemed.",
          "format": "date-time"
        }
      },
      "required": [
        "id",
        "userId",
        "rewardId",
        "dateEarned"
      ]
    },
    "AdView": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "AdView",
      "type": "object",
      "description": "Represents a video ad view by a user.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the ad view."
        },
        "userId": {
          "type": "string",
          "description": "Reference to UserProfile. (Relationship: UserProfile 1:N AdView)"
        },
        "adId": {
          "type": "string",
          "description": "Identifier for the ad. Could be an external ad network ID."
        },
        "timestamp": {
          "type": "object",
          "description": "The server-side timestamp when the ad was viewed."
        }
      },
      "required": [
        "id",
        "userId",
        "adId",
        "timestamp"
      ]
    },
    "GameProgress": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "GameProgress",
      "type": "object",
      "description": "Represents a user's progress in a specific game.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the game progress record."
        },
        "userId": {
          "type": "string",
          "description": "Reference to UserProfile. (Relationship: UserProfile 1:N GameProgress)"
        },
        "gameId": {
          "type": "string",
          "description": "Reference to Game. (Relationship: Game 1:N GameProgress)"
        },
        "progressData": {
          "type": "string",
          "description": "JSON string representing the user's progress in the game. Format is game-specific."
        },
        "lastUpdated": {
          "type": "string",
          "description": "The date and time the progress was last updated.",
          "format": "date-time"
        }
      },
      "required": [
        "id",
        "userId",
        "gameId",
        "progressData",
        "lastUpdated"
      ]
    },
    "StickerPack": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "StickerPack",
      "type": "object",
      "description": "Represents a pack of digital stickers that can be purchased in the store.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the sticker pack."
        },
        "name": {
          "type": "string",
          "description": "The name of the sticker pack."
        },
        "description": {
          "type": "string",
          "description": "A description of the sticker pack."
        },
        "price": {
          "type": "number",
          "description": "The price of the sticker pack in coins."
        }
      },
      "required": [
        "id",
        "name",
        "price"
      ]
    },
    "CoinPack": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "CoinPack",
      "type": "object",
      "description": "Represents a pack of coins that can be purchased with real money.",
      "properties": {
        "id": { "type": "string", "description": "Unique identifier for the coin pack." },
        "name": { "type": "string", "description": "The name of the coin pack (e.g., 'Starter Pack')." },
        "description": { "type": "string", "description": "A short description of the pack." },
        "coins": { "type": "number", "description": "The number of coins in the pack." },
        "price": { "type": "number", "description": "The price of the pack in USD." }
      },
      "required": ["id", "name", "coins", "price"]
    },
    "AffiliateOffer": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "AffiliateOffer",
      "type": "object",
      "description": "Represents an affiliate offer that users can complete for rewards.",
      "properties": {
        "id": { "type": "string", "description": "Unique identifier for the offer." },
        "title": { "type": "string", "description": "The title of the offer." },
        "description": { "type": "string", "description": "A description of the offer." },
        "link": { "type": "string", "description": "The affiliate URL." },
        "imageUrl": { "type": "string", "description": "URL for the offer's image." },
        "imageHint": { "type": "string", "description": "Keywords for AI image search." },
        "rewardCoins": { "type": "number", "description": "Coins awarded for completing the offer." }
      },
      "required": ["id", "title", "description", "link", "imageUrl", "imageHint", "rewardCoins"]
    },
    "UserAffiliate": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "UserAffiliate",
      "type": "object",
      "description": "Tracks a user's completion of an affiliate offer.",
      "properties": {
        "id": { "type": "string", "description": "Unique ID for this completion record." },
        "userId": { "type": "string", "description": "ID of the user who completed the offer." },
        "offerId": { "type": "string", "description": "ID of the completed affiliate offer." },
        "completedAt": { "type": "string", "description": "Timestamp of completion.", "format": "date-time" }
      },
      "required": ["id", "userId", "offerId", "completedAt"]
    }
  },
  "auth": {
    "providers": [
      "password"
    ]
  },
  "firestore": {
    "structure": [
      {
        "path": "/users/{userId}",
        "definition": {
          "entityName": "UserProfile",
          "schema": {
            "$ref": "#/backend/entities/UserProfile"
          },
          "description": "Stores user profile information, keyed by Firebase Auth user ID. Path-based ownership: only the user with matching userId can read/write. This implicitly grants the user to read and write all subcollections of this document.",
          "params": [
            {
              "name": "userId",
              "description": "The unique ID of the user, from Firebase Auth."
            }
          ]
        }
      },
      {
        "path": "/games/{gameId}",
        "definition": {
          "entityName": "Game",
          "schema": {
            "$ref": "#/backend/entities/Game"
          },
          "description": "Stores game metadata. Publicly readable, but only admins (defined elsewhere, perhaps via a role collection) can create/update.",
          "params": [
            {
              "name": "gameId",
              "description": "The unique ID of the game."
            }
          ]
        }
      },
      {
        "path": "/rewards/{rewardId}",
        "definition": {
          "entityName": "Reward",
          "schema": {
            "$ref": "#/backend/entities/Reward"
          },
          "description": "Stores reward definitions. Publicly readable, but only admins can create/update.",
          "params": [
            {
              "name": "rewardId",
              "description": "The unique ID of the reward."
            }
          ]
        }
      },
      {
        "path": "/stickerPacks/{stickerPackId}",
        "definition": {
          "entityName": "StickerPack",
          "schema": {
            "$ref": "#/backend/entities/StickerPack"
          },
          "description": "Stores sticker pack information. Publicly readable, but only admins can create/update.",
          "params": [
            {
              "name": "stickerPackId",
              "description": "The unique ID of the sticker pack."
            }
          ]
        }
      },
       {
        "path": "/coinPacks/{coinPackId}",
        "definition": {
          "entityName": "CoinPack",
          "schema": { "$ref": "#/backend/entities/CoinPack" },
          "description": "Stores coin pack definitions. Publicly readable, but only admins can create/update.",
          "params": [{ "name": "coinPackId", "description": "The unique ID of the coin pack." }]
        }
      },
      {
        "path": "/affiliateOffers/{offerId}",
        "definition": {
          "entityName": "AffiliateOffer",
          "schema": { "$ref": "#/backend/entities/AffiliateOffer" },
          "description": "Stores affiliate offer details. Publicly readable, but only admins can create/update.",
          "params": [{ "name": "offerId", "description": "The unique ID of the affiliate offer." }]
        }
      },
      {
        "path": "/users/{userId}/rewards/{rewardId}",
        "definition": {
          "entityName": "UserReward",
          "schema": {
            "$ref": "#/backend/entities/UserReward"
          },
          "description": "Stores rewards earned or redeemed by a user. Path-based ownership: only the user with matching userId can read/write.",
          "params": [
            {
              "name": "userId",
              "description": "The unique ID of the user."
            },
            {
              "name": "rewardId",
              "description": "The unique ID of the reward."
            }
          ]
        }
      },
      {
        "path": "/users/{userId}/adViews/{adViewId}",
        "definition": {
          "entityName": "AdView",
          "schema": {
            "$ref": "#/backend/entities/AdView"
          },
          "description": "Stores ad views by a user. Path-based ownership: only the user with matching userId can read/write.",
          "params": [
            {
              "name": "userId",
              "description": "The unique ID of the user."
            },
            {
              "name": "adViewId",
              "description": "The unique ID of the ad view."
            }
          ]
        }
      },
      {
        "path": "/users/{userId}/gameProgress/{gameProgressId}",
        "definition": {
          "entityName": "GameProgress",
          "schema": {
            "$ref": "#/backend/entities/GameProgress"
          },
          "description": "Stores game progress for a user. Path-based ownership: only the user with matching userId can read/write.",
          "params": [
            {
              "name": "userId",
              "description": "The unique ID of the user."
            },
            {
              "name": "gameProgressId",
              "description": "The unique ID of the game progress record."
            }
          ]
        }
      },
       {
        "path": "/users/{userId}/affiliateSignups/{offerId}",
        "definition": {
          "entityName": "UserAffiliate",
          "schema": { "$ref": "#/backend/entities/UserAffiliate" },
          "description": "Tracks which affiliate offers a user has completed. Path-based ownership.",
          "params": [
            { "name": "userId", "description": "The unique ID of the user." },
            { "name": "offerId", "description": "The unique ID of the offer." }
          ]
        }
      }
    ],
    "reasoning": "The Firestore structure is designed to support the RewardPlay application, focusing on scalability, security, and ease of maintenance. It leverages path-based ownership for user-specific data and denormalization where necessary to maintain authorization independence. The structure avoids complex rules by segregating data based on access patterns.\n\n*   **User Profiles:** `/users/{userId}` stores user profile data. This is a path-based ownership model, making rules straightforward.\n*   **Games:** `/games/{gameId}` stores game metadata. These are globally accessible.\n*   **Rewards:** `/rewards/{rewardId}` stores reward definitions. These are also globally accessible.\n*   **Sticker Packs:** `/stickerPacks/{stickerPackId}` stores sticker pack definitions. These are also globally accessible.\n*   **Coin Packs:** `/coinPacks/{coinPackId}` stores coin pack definitions. These are also globally accessible.\n*   **Affiliate Offers:** `/affiliateOffers/{offerId}` stores affiliate offer details, publicly readable but writeable only by admins.\n*   **User-Specific Subcollections:** All subcollections under `/users/{userId}` (rewards, adViews, gameProgress, affiliateSignups) implicitly inherit authorization based on the `userId` in the path. This eliminates the need for `get()` calls in security rules to validate user ownership, enabling atomic operations.\n\n**Authorization Independence:**  All subcollections under `/users/{userId}` (rewards, adViews, gameProgress) implicitly inherit authorization based on the `userId` in the path. This eliminates the need for `get()` calls in security rules to validate user ownership, enabling atomic operations.\n\n**QAPs Support:** Segregation into user-owned subcollections enables efficient and secure `list` operations. Rules can simply check `request.auth.uid == userId` for any operations on `/users/{userId}/**`.\n\nThis structure avoids the use of custom claims (DBAC), relying solely on `request.auth.uid` for authorization, and enforces consistent naming conventions to improve debuggability."
  }
}

    